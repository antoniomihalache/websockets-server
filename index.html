<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="stylesheet" href="styles.css" />
        <title>Document</title>
    </head>
    <body>
        <div id="wrapper">
            <!-- headers -->
            <h1>WebSockets Echo Demo</h1>
            <button type="submit" id="open_ws">Open WS</button>
            <div id="status">Status: Not connected</div>
            <div id="server_response"></div>
            <!-- message table -->
            <ul id="table"></ul>
            <!-- form -->
            <form id="form">
                <textarea id="message" placeholder="Write your message here..." required></textarea>
                <button type="submit">Send Message</button>
                <button id="close_ws">Close Connection</button>
                <button type="buttton" id="populate">Populate</button>
            </form>
        </div>
        <script>
            // *** DOM ELEMENTS ***
            // buttons
            let open_ws_btn = document.getElementById('open_ws');
            let close_ws_btn = document.getElementById('close_ws');
            //form
            let form = document.getElementById('form');
            // other message related items
            let socketStatus = document.getElementById('status');
            let table = document.getElementsByTagName('ul')[0];
            let message = document.getElementById('message');
            let populate_btn = document.getElementById('populate');
            let serverResponse = document.getElementById('server_response');

            // *** WEBSOCKET SERVER ***
            open_ws_btn.addEventListener('click', () => {
                open_ws_btn.disabled = true;
                open_ws_btn.style.background = 'gray';
                open_ws_btn.style.pointerEvents = 'none';
                open_ws_btn.textContent = 'Button disabled';

                socketStatus.innerHTML = 'Connecting ...';

                // #1 define websocket server location
                let url = 'wss://localhost:4430';
                // #2. open up websocket server, using the client-side WebSocket API
                let socket = new WebSocket(url);

                // OPEN EVENT
                socket.onopen = (openEvent) => {
                    // check its readyState property, it should be in connected state inside here as the 'open' event has been fired
                    console.log('SOCKET CONNECTING STATUS IS: ' + socket.readyState);
                    // reset table values
                    table.innerHTML = '';
                    serverResponse.innerHTML = '';
                    // provide client-side feedback
                    console.log('SOCKET CONNECTING STATUS IS: ' + socket.readyState);
                    socketStatus.innerHTML = `Connected to: ${openEvent.currentTarget.url}`;
                    socketStatus.className = 'open';
                    // show the form
                    form.className = 'show';
                    let lorem = 'A'.repeat(150000);

                    populate_btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        message.value = lorem;
                    });
                };

                // MESSAGE EVENT: handle messages when they are received from server
                socket.onmessage = function (messageEvent) {
                    if (messageEvent.data instanceof Blob) {
                        let reader = new FileReader();
                        reader.readAsText(messageEvent.data);
                        reader.onload = function () {
                            console.log('Message received from server: ', reader.result);
                            table.innerHTML += '<li class="received"><span>RECEIVED:</span>' + reader.result + '</li>';
                        };
                    } else {
                        console.log('Received non-Blob data: ', messageEvent.data);
                    }
                };

                // CLOSE EVENT
                socket.onclose = (closeEventObject) => {
                    console.log('CLOSE EVENT FIRED. CLOSE OBJECT', closeEventObject);

                    socketStatus.className = 'closed';
                    table.innerHTML = '';

                    switch (closeEventObject.code) {
                        case 1001: // if a peer (client or server) closes the connection immediately
                            socketStatus.innerHTML = `Disconnected reason: ${closeEventObject.reason}`;
                            table.innerHTML = '';
                            break;
                        case 1002:
                            socketStatus.innerHTML = `Protocol error: ${closeEventObject.reason}`;
                            table.innerHTML = '';
                            break;
                        case 1003:
                            socketStatus.innerHTML = `Unsupported data type.`;
                            table.innerHTML = '';
                            break;
                        case 1006: // network problem (e.g. your websocket server is not running)
                            socketStatus.innerHTML = 'Something is wrong with your WS newtork connection';
                            break;
                        case 1008:
                            socketStatus.innerHTML = `You violated server policy`;
                            serverResponse.innerHTML = `The server responded: ${closeEventObject.reason}`;
                            table.innerHTML = '';
                            break;
                        case 1009:
                            socketStatus.innerHTML = 'Message too big for me to handle. Max allowed is 1 MiB';
                            serverResponse.innerHTML = `The server responded: ${closeEventObject.reason}`;
                            table.innerHTML = '';
                            break;

                        default: // when the client hits the close websocket button
                            socketStatus.innerHTML = `You disconnected by clicking the Close button.`;
                            serverResponse.innerHTML = `The server responded: ${closeEventObject.reason}`;
                    }

                    // CSS: FORM REMOVAL
                    form.classList.remove('show');
                    message.setAttribute('required', 'true');
                    open_ws_btn.disabled = false;
                    open_ws_btn.style.background = '';
                    open_ws_btn.style.pointerEvents = '';
                    open_ws_btn.textContent = 'Open WS';
                };

                // ERROR EVENT
                socket.onerror = (error) => {
                    console.log('Error event was thrown. ERROR OBJECT: ', error);
                    socketStatus.innerHTML = 'Error.';
                    socketStatus.className = 'closed';
                };

                // *** SEND METHOD
                form.addEventListener('submit', (e) => {
                    e.preventDefault();

                    // implement extra safety measure by checking readyState before sending WS data
                    if (socket.readyState === 1) {
                        let user_text = message.value;
                        socket.send(user_text);
                        // update table
                        table.innerHTML += '<li class="sent"><span>SENT:</span>' + user_text + '</li>';
                        message.value = '';
                    }
                });

                // *** CLOSE METHOD
                close_ws_btn.addEventListener('click', () => {
                    socketStatus.innerHTML = 'closing ... please wait ...';
                    socketStatus.classList.add('closing');
                    // close the websocket connection
                    socket.close(1000, "I don't like you");
                    // styling
                    message.removeAttribute('required');
                    form.classList.remove('show');
                });
            });
        </script>
    </body>
</html>
